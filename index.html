<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Floating Chatbot</title>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #chat-bubble {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #007bff;
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 30px;
      text-align: center;
      line-height: 60px;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    #chat-bubble:hover {
      transform: scale(1.1);
    }
    #chat-container {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 360px;
      height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 9998;
      font-family: Arial, sans-serif;
      transition: all 0.3s ease;
    }
    #chatbox {
      flex-grow: 1;
      padding: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
    }
    .bot, .user {
      margin: 6px 0;
      padding: 10px;
      border-radius: 10px;
      max-width: 80%;
      line-height: 1.4;
      word-wrap: break-word;
    }
    .bot {
      background: #e6f0ff;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .user {
      background: #d1f0e5;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    #inputRow {
      display: flex;
      padding: 10px;
      border-top: 1px solid #eee;
      background: white;
    }
    #userInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-right: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    #userInput:focus {
      outline: none;
      border-color: #007bff;
    }
    #sendBtn {
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    #sendBtn:hover {
      background: #0056b3;
    }
    #sendBtn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<div id="chat-bubble">💬</div>

<div id="chat-container">
  <div id="chatbox">
    <div class="bot">Hi, how can I help you today?</div>
  </div>
  <div id="inputRow">
    <input type="text" id="userInput" placeholder="Type your message..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
const bubble = document.getElementById("chat-bubble");
const container = document.getElementById("chat-container");
const chatbox = document.getElementById("chatbox");
const input = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

let flow = null;
let step = null;
let data = { name: null, phone: null, email: null, quantity: null, product: null, address: null };

function addMessage(text, sender = "bot") {
  const msg = document.createElement("div");
  msg.className = sender;
  msg.textContent = text;
  chatbox.appendChild(msg);
  msg.scrollIntoView({ behavior: "smooth", block: "end" });
}

function isGreeting(msg) {
  return /\b(hi|hello|hey|good\s(morning|afternoon|evening))\b/i.test(msg);
}

function isNegativeResponse(msg) {
  return /\b(no|no\s(thank|thanks)|nah|i\s*m\s*good)\b/i.test(msg);
}

function detectIntent(msg) {
  const lower = msg.toLowerCase();
  
  // Direct gas order intent
  if (lower.includes('gas') || lower.includes('cylinder')) {
    return "order";
  }
  
  // Registration intent
  if (lower.match(/register|sign.*up|add.*customer|new.*customer/)) {
    return "register";
  }
  
  // General order intent
  if (lower.match(/order|buy|book|place.*order/)) {
    return "order";
  }
  
  return null;
}

function validateInput(type, value) {
  switch(type) {
    case 'phone':
      return /^\+?\d{10,}$/.test(value.replace(/[\s-]/g, ''));
    case 'email':
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
    case 'quantity':
      return /^\d+$/.test(value) && parseInt(value) > 0;
    default:
      return value.length > 0;
  }
}

function handleInput() {
  const msg = input.value.trim();
  if (!msg) return;

  // Add user message to chat
  addMessage(msg, "user");
  input.value = "";

  if (isNegativeResponse(msg)) {
    addMessage("Alright, have a great day! 😊");
    resetChat();
    return;
  }

  const intent = detectIntent(msg);

  if (!flow) {
    if (isGreeting(msg)) {
      // If greeting includes order intent, skip the generic question
      const greetingIntent = detectIntent(msg);
      if (greetingIntent === "order") {
        flow = "order";
        step = "quantity";
        addMessage("Sure! How many gas cylinders would you like?");
        return;
      }
      addMessage("Hello! Would you like to place an order or register as a customer?");
      return;
    }

    if (intent === "register") {
      flow = "register";
      step = "name";
      addMessage("Sure! What's your name?");
      return;
    }

    if (intent === "order") {
      flow = "order";
      step = "quantity";
      addMessage("Sure! How many gas cylinders would you like?");
      return;
    }

    addMessage("Sorry, I didn't understand. Try saying 'I'd like to order gas' or 'register me'.");
    return;
  }

  // Handle registration flow
  if (flow === "register") {
    switch(step) {
      case "name":
        if (!validateInput('name', msg)) {
          addMessage("Please enter a valid name.");
          return;
        }
        data.name = msg;
        step = "phone";
        addMessage("Thanks. What's your phone number?");
        break;
      case "phone":
        if (!validateInput('phone', msg)) {
          addMessage("Please enter a valid phone number (at least 10 digits).");
          return;
        }
        data.phone = msg;
        step = "email";
        addMessage("Great. And your email address?");
        break;
      case "email":
        if (!validateInput('email', msg)) {
          addMessage("Please enter a valid email address.");
          return;
        }
        data.email = msg;
        submitData("addCustomer", data);
        break;
    }
    return;
  }

  // Handle order flow
  if (flow === "order") {
    switch(step) {
      case "quantity":
        if (!validateInput('quantity', msg)) {
          addMessage("Please enter a valid quantity (a positive number).");
          return;
        }
        data.quantity = msg;
        step = "product";
        addMessage("What capacity cylinders would you like? (e.g., 9kg, 45kg)");
        break;
      case "product":
        data.product = msg;
        if (!data.name) {
          step = "name";
          addMessage("What is your name?");
        } else {
          step = "address";
          addMessage("What is your delivery address?");
        }
        break;
      case "name":
        if (!validateInput('name', msg)) {
          addMessage("Please enter a valid name.");
          return;
        }
        data.name = msg;
        step = "address";
        addMessage("What is your delivery address?");
        break;
      case "address":
        if (!validateInput('address', msg)) {
          addMessage("Please enter a valid address.");
          return;
        }
        data.address = msg;
        submitData("placeOrder", data);
        break;
    }
    return;
  }
}

function resetChat() {
  flow = null;
  step = null;
  data = { name: null, phone: null, email: null, quantity: null, product: null, address: null };
}

function submitData(action, payload) {
  sendBtn.disabled = true;
  input.disabled = true;
  
  fetch("https://chatbot-proxy-803731777943.us-central1.run.app", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action, ...payload })
  })
    .then(r => r.text())
    .then(txt => {
      addMessage(txt || "✅ Done!");
      setTimeout(() => addMessage("Can I help you with anything else?"), 500);
      resetChat();
    })
    .catch(() => {
      addMessage("⚠️ Something went wrong. Please try again.");
      resetChat();
    })
    .finally(() => {
      sendBtn.disabled = false;
      input.disabled = false;
    });
}

// Event Listeners
bubble.onclick = () => {
  container.style.display = container.style.display === "flex" ? "none" : "flex";
  if (container.style.display === "flex") {
    input.focus();
  }
};

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    handleInput();
  }
});

sendBtn.addEventListener("click", handleInput);

// Enable/disable send button based on input
input.addEventListener("input", () => {
  sendBtn.disabled = !input.value.trim();
});
</script>
</body>
</html>